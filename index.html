<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Panel API Key</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css?family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        background: #1e2230;
        color: #eaeaea;
        font-family: "Inter", Arial, sans-serif;
        margin: 0;
        padding: 0;
        height: 100%;
      }
      .main-flex {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: 220px;
        background: #23273a;
        border-right: 2px solid #30344b;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        min-height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 10;
        transition: width 0.2s;
      }
      .sidebar-header {
        padding: 26px 0 12px 0;
        text-align: center;
        font-size: 1.13em;
        font-weight: bold;
        color: #7ed3fc;
        border-bottom: 1px solid #31385a;
        letter-spacing: 1px;
        background: #23273a;
      }
      .sidebar-nav {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .sidebar-nav li {
        padding: 17px 22px 17px 28px;
        border-bottom: 1px solid #282c44;
        color: #eaeaea;
        cursor: pointer;
        font-size: 1.08em;
        font-weight: 600;
        transition: background 0.14s;
        position: relative;
        background: transparent;
      }
      .sidebar-nav li.active,
      .sidebar-nav li:hover {
        background: #29304a;
        color: #7ed3fc;
      }
      .sidebar-list-header {
        font-size: 0.98em;
        color: #b5b9c9;
        margin: 13px 0 7px 21px;
        font-weight: bold;
      }
      .sidebar-list {
        list-style: none;
        margin: 0;
        padding: 0 0 0 6px;
        font-size: 1.03em;
        overflow-y: auto;
        flex: 1 1 auto;
      }
      .sidebar-list li {
        padding: 8px 16px 8px 22px;
        color: #eaeaea;
        cursor: default;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.14s;
        border-bottom: none;
        background: transparent;
        font-weight: normal;
        border-radius: 6px;
      }
      .sidebar-list li.me {
        background: #232d47;
        color: #7ed3fc;
        font-weight: bold;
      }
      .sidebar-list li.superadmin::after {
        content: "â˜…";
        color: #ffe082;
        font-size: 1em;
        margin-left: 9px;
        opacity: 0.85;
      }
      .container {
        display: inline-block;
        background: rgba(34, 37, 54, 0.98);
        border-radius: 14px;
        box-shadow: 0 2px 36px #0008;
        padding: 32px 26px 32px 26px;
        position: relative;
        margin: 40px auto 20px 240px;
        min-width: 320px;
        max-width: 95vw;
        width: auto;
        vertical-align: top;
        transition:
          margin 0.2s,
          padding 0.2s;
      }
      .logout-btn {
        position: absolute;
        top: 16px;
        right: 22px;
        padding: 8px 18px;
        background: #e03f66;
        color: #fff;
        font-weight: 700;
        border-radius: 8px;
        border: none;
        font-size: 1em;
        cursor: pointer;
        z-index: 2;
        transition: opacity 0.15s;
      }
      .logout-btn:active {
        opacity: 0.7;
      }
      h2 {
        text-align: center;
        color: #7ed3fc;
        letter-spacing: 1px;
        font-weight: 700;
        margin-bottom: 26px;
      }
      label {
        font-weight: 500;
        color: #c9e0f7;
      }
      input,
      select,
      button {
        font-size: 1.07rem;
        border-radius: 7px;
        border: 1.5px solid #3e5175;
        padding: 10px 12px;
        background: #23273a;
        color: #f1f1f1;
        outline: none;
        transition: border 0.18s;
        font-family: inherit;
        box-sizing: border-box;
        margin-bottom: 10px;
        width: 100%;
        max-width: 350px;
      }
      input:focus,
      select:focus {
        border-color: #4dc3ff;
      }
      button {
        background: linear-gradient(90deg, #0ea6f7 0%, #5e4b8b 100%);
        color: #fff;
        border: none;
        cursor: pointer;
        font-weight: 700;
        box-shadow: 0 2px 8px 0 #0099ff17;
        transition:
          background 0.2s,
          box-shadow 0.2s,
          opacity 0.17s;
        padding: 10px 20px;
        border-radius: 7px;
        width: auto;
        min-width: 120px;
      }
      button:active {
        opacity: 0.82;
      }
      ul {
        padding-left: 0;
        margin-top: 0;
        margin-bottom: 0;
      }
      .success {
        color: #43ffae;
        font-size: 1.04em;
        margin-top: 6px;
        font-weight: 600;
        letter-spacing: 0.5px;
        display: block;
      }
      .error {
        color: #ff5b7c;
        font-size: 1.04em;
        margin-top: 6px;
        font-weight: 600;
        letter-spacing: 0.5px;
        display: block;
      }
      .admin-item {
        margin-bottom: 8px;
        padding: 7px 0;
        border-bottom: 1px solid #2e3040;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .key-list-section {
        margin-top: 46px;
      }
      .key-list-title {
        color: #e89cff;
        font-size: 1.13em;
        font-weight: bold;
        margin-bottom: 12px;
      }
      .key-list-search-wrap {
        margin-bottom: 12px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 12px;
      }
      .key-list-search {
        width: 180px;
        max-width: 70vw;
        padding: 8px 10px;
        margin-bottom: 0;
      }
      .key-list-table {
        width: 100%;
        border-collapse: collapse;
        background: transparent;
        margin-bottom: 10px;
      }
      .key-list-table th,
      .key-list-table td {
        padding: 8px 6px;
        border-bottom: 1px solid #29304a;
        text-align: left;
        font-size: 0.99em;
        word-break: break-all;
        vertical-align: middle;
      }
      .key-list-table th {
        color: #7ed3fc;
        background: #23273a;
      }
      .key-list-table td.expired {
        color: #ff5959;
      }
      .no-keys {
        color: #7da9c7;
        font-style: italic;
        padding: 14px 0;
        text-align: center;
      }
      .copy-btn {
        background: #3e7ad1;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 4px 10px;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        margin-left: 2px;
        transition: opacity 0.15s;
      }
      .copy-btn:active {
        opacity: 0.7;
      }
      .revoke-btn {
        background: #e03f66;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 4px 10px;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        margin-left: 2px;
        transition: opacity 0.18s;
      }
      .revoke-btn:active {
        opacity: 0.8;
      }
      .rename-btn {
        background: #0ea6f7;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 4px 10px;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        margin-left: 2px;
        transition: opacity 0.15s;
      }
      .rename-btn:active {
        opacity: 0.7;
      }
      .rename-input {
        width: 100px;
        border-radius: 4px;
        border: 1px solid #4dc3ff;
        background: #23273a;
        color: #fff;
        padding: 4px 6px;
        font-size: 0.96em;
        margin-right: 3px;
      }
      .extend-btn {
        background: #43ffae;
        color: #222;
        border: none;
        border-radius: 6px;
        padding: 4px 10px;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        margin-left: 2px;
        transition: opacity 0.14s;
      }
      .extend-btn:active {
        opacity: 0.7;
      }
      .extend-select {
        background: #23273a;
        color: #fff;
        border-radius: 5px;
        border: 1px solid #4dc3ff;
        font-size: 0.96em;
        margin-left: 4px;
        padding: 4px 7px;
      }
      .delete-btn {
        background: #e03f66;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 4px 10px;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.18s;
      }
      .delete-btn:active {
        opacity: 0.8;
      }
      .approve-btn {
        background: #43ffae;
        color: #222;
        border: none;
        border-radius: 6px;
        padding: 4px 10px;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.14s;
      }
      .approve-btn:active {
        opacity: 0.7;
      }
      .reject-btn {
        background: #ff5b7c;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 4px 10px;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.18s;
      }
      .reject-btn:active {
        opacity: 0.8;
      }
      @media (max-width: 1000px) {
        .container {
          margin-left: 75px;
        }
        .sidebar {
          width: 60px;
        }
        .sidebar-header {
          font-size: 1em;
          padding: 18px 0 8px 0;
        }
        .sidebar-nav li {
          font-size: 0.98em;
          padding-left: 10px;
        }
        .sidebar-list-header {
          margin-left: 8px;
        }
        .sidebar-list li span {
          display: none;
        }
        .logout-btn {
          right: 7px;
        }
      }
      @media (max-width: 650px) {
        .main-flex {
          flex-direction: column;
        }
        .sidebar {
          display: none !important;
        }
        .container {
          margin-left: 0;
          padding: 13px 3vw 14px 3vw;
          margin: 15px 1vw;
          min-width: 0;
          width: 98vw;
          box-sizing: border-box;
          border-radius: 10px;
        }
        input,
        select,
        button {
          max-width: 98vw;
        }
        .key-list-table th,
        .key-list-table td {
          font-size: 0.93em;
        }
        .logout-btn {
          position: static;
          width: 100%;
          margin-bottom: 12px;
          margin-top: 2px;
          right: auto;
        }
        h2 {
          font-size: 1.11em;
        }
        .key-list-search-wrap {
          flex-direction: column;
          gap: 7px;
        }
        .key-list-search {
          width: 100%;
          min-width: 0;
        }
        .login-card input {
          min-width: 0;
          width: 94vw;
        }
        .login-card {
          padding: 28px 5vw 20px 5vw;
          min-width: 0;
          width: 98vw;
        }
      }
      .flex-center {
        min-height: 100vh;
        width: 100vw;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #1e2230;
        position: fixed;
        left: 0;
        top: 0;
        z-index: 100;
        transition: background 0.2s;
      }
      .login-card {
        background: #24273a;
        border-radius: 13px;
        box-shadow: 0 2px 16px #0007;
        padding: 38px 32px 30px 32px;
        min-width: 270px;
        width: fit-content;
        max-width: 96vw;
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 1.5px solid #314584;
        color: #fff;
        margin: 0;
      }
      .login-card input {
        margin-bottom: 18px;
        width: 240px;
        max-width: 80vw;
      }
      .login-title {
        font-size: 1.3em;
        font-weight: 700;
        color: #7ed3fc;
        margin-bottom: 12px;
        text-align: center;
      }
      .login-btn {
        background: linear-gradient(90deg, #0ea6f7 0%, #5e4b8b 100%);
        color: #fff;
        font-weight: 600;
        border-radius: 7px;
        border: none;
        padding: 10px 0;
        font-size: 1.07em;
        width: 100%;
        margin-top: 8px;
        cursor: pointer;
        transition: opacity 0.15s;
      }
      .login-btn:active {
        opacity: 0.75;
      }
      @media (max-width: 650px) {
        .login-card input {
          min-width: 0;
          width: 90vw;
        }
        .login-card {
          padding: 18px 2vw 14px 2vw;
        }
        .cookie-chat-item {
          background: #232d47;
          border-radius: 9px;
          margin-bottom: 13px;
          padding: 12px 16px 10px 16px;
          box-shadow: 0 2px 12px #0003;
          font-size: 1.06em;
        }
        .cookie-chat-cookie {
          color: #7ed3fc;
          font-family: monospace, monospace;
          font-size: 1.08em;
          word-break: break-all;
        }
        .cookie-chat-meta {
          color: #b5b9c9;
          font-size: 13px;
          margin-top: 3px;
          display: flex;
          flex-wrap: wrap;
          gap: 8px 18px;
          align-items: center;
        }
        .cookie-chat-keyname {
          color: #e89cff;
          font-weight: bold;
        }
        .cookie-chat-device {
          color: #43ffae;
          font-size: 12.5px;
          font-family: monospace;
          margin-left: 8px;
          background: #1e2230;
          border-radius: 4px;
          padding: 1px 6px;
          display: inline-block;
        }
        .cookie-chat-ua {
          color: #999;
          font-size: 12px;
        }
        .cookie-chat-ip {
          color: #ffa07a;
          font-size: 12.2px;
        }
        .cookie-chat-empty {
          color: #7da9c7;
          font-style: italic;
          padding: 13px 0;
          text-align: center;
        }
        .cookie-chat-panel-header {
          font-size: 1.08em;
          color: #7ed3fc;
          margin-bottom: 11px;
          font-weight: bold;
        }
        .cookie-chat-panel-desc {
          color: #b5b9c9;
          margin-bottom: 15px;
          font-size: 13.4px;
        }
        .cookie-chat-panel {
          max-width: 780px;
          margin: 0 auto 30px auto;
          background: #222a3c;
          border-radius: 13px;
          box-shadow: 0 2px 16px #0002;
          padding: 24px 17px 18px 17px;
          min-height: 150px;
        }
        .cookie-chat-refresh-btn {
          background: linear-gradient(90deg, #0ea6f7 0%, #5e4b8b 100%);
          color: #fff;
          font-weight: 700;
          border-radius: 7px;
          border: none;
          padding: 8px 22px;
          font-size: 1.03em;
          margin-bottom: 7px;
          margin-top: 0;
          margin-right: 14px;
          cursor: pointer;
          box-shadow: 0 1px 7px #0099ff17;
          transition: opacity 0.15s;
        }
        .cookie-chat-refresh-btn:active {
          opacity: 0.8;
        }
        @media (max-width: 700px) {
          .cookie-chat-panel {padding: 13px 5vw;}
        }
        /* Tambahan untuk status device */
            .device-status-online {
                    color: #43ffae;
                    font-weight: bold;
                  }
                  .device-status-offline {
                    color: #ff5b7c;
                    font-weight: bold;
                  }
    </style>
  </head>
  <body>
    <div class="main-flex">
      <nav class="sidebar" id="sidebar" style="display: none">
        <div class="sidebar-header">Admin Panel</div>
        <ul class="sidebar-nav">
          <li id="navAdmins" class="active" onclick="showPage('admins')">
            Daftar Admin
          </li>
          <li id="navRegister" onclick="showPage('register')">
            Register Admin
          </li>
          <li id="navApproveReject" onclick="showPage('approveReject')">
            Approve/Tolak
          </li>
          <li id="navChangePassword" onclick="showPage('changePassword')">
            Ganti Password
          </li>
          <li id="navKeys" onclick="showPage('keys')">Generate Key</li>
          <li id="navCookies" onclick="showPage('cookies')">Monitor Cookie</li>
        </ul>
        <div class="sidebar-list-header">List Admin:</div>
        <ul class="sidebar-list" id="sidebarAdminList"></ul>
      </nav>
      <button class="logout-btn" id="logoutBtn" style="display: none">
        Logout
      </button>
      <div class="container" id="mainPanel" style="display: none">
        <!-- === Panel Chat/Monitor Cookie Extension === -->
        <div id="pageCookies" style="display: none">
          <h2>Monitor Cookie dari Extension</h2>
          <div class="cookie-chat-panel-header">
            Cookie _cfwaitingroom (Realtime)
          </div>
          <div class="cookie-chat-panel-desc">
            Panel ini menampilkan <b>cookie _cfwaitingroom</b> yang dikirim
            extension secara real-time.<br />
            Device ID dan Nama Key akan tampil sesuai API key yang dipakai
            extension.
          </div>
          <div class="cookie-chat-panel">
            <button class="cookie-chat-refresh-btn" id="refreshCookieBtn">
              Refresh
            </button>
            <span style="font-size: 13px; color: #7ed3fc"
              >Panel ini auto-refresh setiap 3 detik</span
            >
            <div
              id="cookieChatList"
              style="max-height: 320px; overflow-y: auto; margin-top: 16px"
            ></div>
          </div>
        </div>

        <!-- Halaman Daftar Admin -->
        <div id="pageAdmins">
          <h2>Daftar Admin</h2>
          <ul id="adminsList"></ul>
        </div>
        <!-- Halaman Register Admin -->
        <div id="pageRegister" style="display: none">
          <h2>Register Admin Baru</h2>
          <label for="registerUsername">Username:</label>
          <input
            type="text"
            id="registerUsername"
            placeholder="Masukkan username"
            autocomplete="username"
          />
          <label for="registerPassword">Password:</label>
          <input
            type="password"
            id="registerPassword"
            placeholder="Masukkan password"
            autocomplete="new-password"
          />
          <button id="registerBtn">Register</button>
          <div id="registerResult"></div>
        </div>
        <!-- Halaman Approve/Tolak Admin -->
        <div id="pageApproveReject" style="display: none">
          <h2>Approve/Tolak Admin</h2>
          <ul id="pendingList"></ul>
          <div id="approveRejectResult"></div>
        </div>
        <!-- Halaman Ganti Password -->
        <div id="pageChangePassword" style="display: none">
          <h2>Ganti Password</h2>
          <label for="oldPassword">Password Lama:</label>
          <input
            type="password"
            id="oldPassword"
            placeholder="Masukkan password lama"
            autocomplete="current-password"
          />
          <label for="newPassword">Password Baru:</label>
          <input
            type="password"
            id="newPassword"
            placeholder="Masukkan password baru"
            autocomplete="new-password"
          />
          <button id="changePasswordBtn">Ganti Password</button>
          <div id="changePasswordResult"></div>
        </div>
        <!-- Halaman Generate Key -->
        <div id="pageKeys" style="display: none">
          <h2>Generate Key</h2>
          <label for="keyName">Nama Key (opsional):</label>
          <input
            type="text"
            id="keyName"
            maxlength="48"
            placeholder="Contoh: Bot Telegram, Device 1, dst..."
          />
          <label for="expireDays">Masa Berlaku:</label>
          <select id="expireDays">
            <option value="1">1 Hari</option>
            <option value="2">2 Hari</option>
            <option value="3">3 Hari</option>
          </select>
          <!-- Tambahan: Pilihan jumlah device -->
          <label for="maxDevices">Jumlah Device:</label>
          <select id="maxDevices">
            <option value="1">1 Device</option>
            <option value="2">2 Device</option>
            <option value="3">3 Device</option>
            <option value="4">4 Device</option>
            <option value="5">5 Device</option>
          </select>
          <button id="generateBtn">Generate Key</button>
          <div id="genResult"></div>
          <div class="key-list-section">
            <div class="key-list-title">Key Aktif</div>
            <div class="key-list-search-wrap">
              <input
                id="searchKeyInput"
                class="key-list-search"
                type="text"
                placeholder="Cari nama key..."
                autocomplete="off"
              />
              <button id="listBtn" style="margin-bottom: 0">
                Refresh List
              </button>
            </div>
            <div id="keysListWrap">
              <table
                class="key-list-table"
                id="keysListTable"
                style="display: none"
              >
                <thead>
                  <tr>
                    <th>API Key</th>
                    <th>Nama Key</th>
                    <th>
                      Expired<br /><span
                        style="font-weight: 400; font-size: 0.97em"
                        >(Countdown)</span
                      >
                    </th>
                    <th>Copy</th>
                    <th>Status Device</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="keysList"></tbody>
              </table>
              <div id="noKeysText" class="no-keys" style="display: none"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="flex-center" id="loginFlex" style="display: none">
        <div class="login-card" id="loginCard">
          <div class="login-title">Login Admin</div>
          <input
            type="text"
            id="loginUser"
            placeholder="Username"
            autocomplete="username"
          />
          <input
            type="password"
            id="loginPass"
            placeholder="Password"
            autocomplete="current-password"
          />
          <button class="login-btn" id="loginBtn">Login</button>
          <div
            id="loginMsg"
            class="error"
            style="margin-top: 10px; min-height: 1em"
          ></div>
        </div>
      </div>
      <div
        class="flex-center"
        id="extendModal"
        style="display: none; z-index: 500"
      >
        <div
          class="login-card"
          style="
            padding: 28px 28px 20px 28px;
            min-width: 230px;
            max-width: 98vw;
          "
        >
          <div style="font-size: 1.13em; font-weight: 600; margin-bottom: 14px">
            Tambah Waktu Key
          </div>
          <div
            id="extendModalKeyName"
            style="color: #7ed3fc; margin-bottom: 10px"
          ></div>
          <label for="extendDays">Tambah waktu:</label>
          <select id="extendDays" class="extend-select">
            <option value="1">1 Hari</option>
            <option value="2">2 Hari</option>
            <option value="3">3 Hari</option>
          </select>
          <button class="extend-btn" id="confirmExtendBtn">Tambah</button>
          <button
            class="revoke-btn"
            id="cancelExtendBtn"
            style="margin-left: 10px"
          >
            Batal
          </button>
          <div
            id="extendMsg"
            class="error"
            style="min-height: 1.2em; margin-top: 10px"
          ></div>
        </div>
      </div>
    </div>
    <script>
      let myUsername = "",
        myRole = "";
      let allKeyData = [];
      let currentEditingKey = null;
      let currentExtendKey = null;
      let countdownInterval = null;

      function showPanel(loggedIn, role = "") {
        document.getElementById("mainPanel").style.display = loggedIn
          ? ""
          : "none";
        document.getElementById("logoutBtn").style.display = loggedIn
          ? ""
          : "none";
        document.getElementById("loginFlex").style.display = loggedIn
          ? "none"
          : "flex";
        document.getElementById("sidebar").style.display = loggedIn
          ? ""
          : "none";
        document.getElementById("navApproveReject").style.display =
          role === "superadmin" ? "" : "none";
        if (loggedIn) {
          showPage("admins");
          loadAdmins();
        } else {
          document.getElementById("adminsList").innerHTML = "";
          document.getElementById("sidebarAdminList").innerHTML = "";
          document.getElementById("pendingList").innerHTML = "";
          clearCountdown();
        }
      }

      function showPage(page) {
        document.getElementById("pageAdmins").style.display =
          page === "admins" ? "" : "none";
        document.getElementById("pageRegister").style.display =
          page === "register" ? "" : "none";
        document.getElementById("pageApproveReject").style.display =
          page === "approveReject" ? "" : "none";
        document.getElementById("pageChangePassword").style.display =
          page === "changePassword" ? "" : "none";
        document.getElementById("pageKeys").style.display =
          page === "keys" ? "" : "none";
        document
          .getElementById("navAdmins")
          .classList.toggle("active", page === "admins");
        document
          .getElementById("navRegister")
          .classList.toggle("active", page === "register");
        document
          .getElementById("navApproveReject")
          .classList.toggle("active", page === "approveReject");
        document
          .getElementById("navChangePassword")
          .classList.toggle("active", page === "changePassword");
        document
          .getElementById("navKeys")
          .classList.toggle("active", page === "keys");
        if (page === "admins") loadAdmins();
        if (page === "approveReject" && myRole === "superadmin")
          loadPendingUsers();
        if (page === "keys") listKeys();
      }

      async function checkStatus() {
        try {
          const res = await fetch("/api/status", { credentials: "include" });
          const data = await res.json();
          myUsername = data.username || "";
          myRole = data.role || "";
          showPanel(!!data.loggedIn, data.role);
        } catch (err) {
          document.getElementById("loginMsg").textContent =
            "Kesalahan server: " + err.message;
        }
      }

      document.getElementById("loginBtn").onclick = async () => {
        const username = document.getElementById("loginUser").value.trim();
        const password = document.getElementById("loginPass").value.trim();
        try {
          const res = await fetch("/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (res.ok) {
            document.getElementById("loginMsg").textContent = "";
            document.getElementById("loginUser").value = "";
            document.getElementById("loginPass").value = "";
            checkStatus();
          } else {
            document.getElementById("loginMsg").textContent =
              data.message || "Login gagal!";
          }
        } catch (err) {
          document.getElementById("loginMsg").textContent =
            "Kesalahan server: " + err.message;
        }
      };

      document.getElementById("logoutBtn").onclick = async () => {
        try {
          await fetch("/api/logout", {
            method: "POST",
            credentials: "include",
          });
          checkStatus();
        } catch (err) {
          document.getElementById("loginMsg").textContent =
            "Kesalahan server: " + err.message;
        }
      };

      async function loadAdmins() {
        try {
          const res = await fetch("/api/admins", { credentials: "include" });
          if (!res.ok) {
            document.getElementById("adminsList").innerHTML =
              `<span class="error">Gagal memuat daftar admin</span>`;
            return;
          }
          const data = await res.json();
          const sidebar = document.getElementById("sidebarAdminList");
          sidebar.innerHTML = "";
          data.admins.forEach((a) => {
            const li = document.createElement("li");
            if (a.username === myUsername) li.classList.add("me");
            if (a.role === "superadmin") li.classList.add("superadmin");
            li.innerHTML = `<span>${a.username}</span>`;
            sidebar.appendChild(li);
          });
          const ul = document.getElementById("adminsList");
          ul.innerHTML = "";
          data.admins.forEach((a) => {
            const li = document.createElement("li");
            li.className = "admin-item";
            let deleteButton = "";
            if (
              myRole === "superadmin" &&
              a.username !== myUsername &&
              a.role !== "superadmin"
            ) {
              deleteButton = `<button class="delete-btn" onclick="deleteAdmin('${a.username}')">Hapus</button>`;
            }
            li.innerHTML = `<span style="font-weight:600;color:#7ed3fc">${a.username}</span> <span style="font-size:.95em;color:#b5b9c9;">(${a.role}${a.approved ? "" : ", menunggu persetujuan"})</span> ${deleteButton}`;
            ul.appendChild(li);
          });
        } catch (err) {
          document.getElementById("adminsList").innerHTML =
            `<span class="error">Kesalahan server: ${err.message}</span>`;
        }
      }

      async function loadPendingUsers() {
        try {
          const res = await fetch("/api/pending-users", {
            credentials: "include",
          });
          if (!res.ok) {
            document.getElementById("pendingList").innerHTML =
              `<span class="error">Gagal memuat daftar pengguna pending</span>`;
            return;
          }
          const data = await res.json();
          const ul = document.getElementById("pendingList");
          ul.innerHTML = "";
          if (!data.pending || data.pending.length === 0) {
            ul.innerHTML = `<span class="no-keys">Tidak ada pengguna menunggu persetujuan</span>`;
            return;
          }
          data.pending.forEach((u) => {
            const li = document.createElement("li");
            li.className = "admin-item";
            li.innerHTML = `<span style="font-weight:600;color:#7ed3fc">${u.username}</span>
                          <button class="approve-btn" onclick="approveUser('${u.username}')">Approve</button>
                          <button class="reject-btn" onclick="rejectUser('${u.username}')">Tolak</button>`;
            ul.appendChild(li);
          });
        } catch (err) {
          document.getElementById("pendingList").innerHTML =
            `<span class="error">Kesalahan server: ${err.message}</span>`;
        }
      }

      async function register() {
        const username = document
          .getElementById("registerUsername")
          .value.trim();
        const password = document
          .getElementById("registerPassword")
          .value.trim();
        try {
          const res = await fetch("/api/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (res.ok) {
            document.getElementById("registerResult").innerHTML =
              `<span class="success">${data.message}</span>`;
            document.getElementById("registerUsername").value = "";
            document.getElementById("registerPassword").value = "";
            loadAdmins();
          } else {
            document.getElementById("registerResult").innerHTML =
              `<span class="error">${data.message || "Registrasi gagal!"}</span>`;
          }
        } catch (err) {
          document.getElementById("registerResult").innerHTML =
            `<span class="error">Kesalahan server: ${err.message}</span>`;
        }
      }

      async function approveUser(username) {
        if (!confirm(`Yakin ingin menyetujui pengguna ${username}?`)) return;
        try {
          const res = await fetch("/api/approve-user", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ username }),
          });
          const data = await res.json();
          if (res.ok) {
            document.getElementById("approveRejectResult").innerHTML =
              `<span class="success">Pengguna ${username} disetujui</span>`;
            loadPendingUsers();
            loadAdmins();
          } else {
            document.getElementById("approveRejectResult").innerHTML =
              `<span class="error">${data.message || "Gagal menyetujui pengguna!"}</span>`;
          }
        } catch (err) {
          document.getElementById("approveRejectResult").innerHTML =
            `<span class="error">Kesalahan server: ${err.message}</span>`;
        }
      }

      async function rejectUser(username) {
        if (!confirm(`Yakin ingin menolak pengguna ${username}?`)) return;
        try {
          const res = await fetch("/api/reject-user", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ username }),
          });
          const data = await res.json();
          if (res.ok) {
            document.getElementById("approveRejectResult").innerHTML =
              `<span class="success">Pengguna ${username} ditolak</span>`;
            loadPendingUsers();
          } else {
            document.getElementById("approveRejectResult").innerHTML =
              `<span class="error">${data.message || "Gagal menolak pengguna!"}</span>`;
          }
        } catch (err) {
          document.getElementById("approveRejectResult").innerHTML =
            `<span class="error">Kesalahan server: ${err.message}</span>`;
        }
      }

      async function changePassword() {
        const oldPassword = document.getElementById("oldPassword").value.trim();
        const newPassword = document.getElementById("newPassword").value.trim();
        try {
          const response = await fetch("/api/change-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ oldPassword, newPassword }),
          });
          const data = await response.json();
          if (response.ok) {
            document.getElementById("changePasswordResult").innerHTML =
              `<span class="success">Password berhasil diubah!</span>`;
            document.getElementById("oldPassword").value = "";
            document.getElementById("newPassword").value = "";
          } else {
            document.getElementById("changePasswordResult").innerHTML =
              `<span class="error">${data.message || "Gagal mengganti password!"}</span>`;
          }
        } catch (err) {
          document.getElementById("changePasswordResult").innerHTML =
            `<span class="error">Kesalahan server: ${err.message}</span>`;
        }
      }

      async function deleteAdmin(username) {
        if (!confirm(`Yakin ingin menghapus admin "${username}"?`)) return;
        try {
          const res = await fetch("/api/delete-admin", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ username }),
          });
          const data = await res.json();
          if (res.ok) {
            document.getElementById("adminsList").innerHTML =
              `<span class="success">Admin ${username} dihapus</span>`;
            loadAdmins();
          } else {
            document.getElementById("adminsList").innerHTML =
              `<span class="error">${data.message || "Gagal menghapus admin!"}</span>`;
          }
        } catch (err) {
          document.getElementById("adminsList").innerHTML =
            `<span class="error">Kesalahan server: ${err.message}</span>`;
        }
      }

      function formatCountdown(ms) {
        if (ms <= 0) return "Expired";
        const totalSeconds = Math.floor(ms / 1000);
        const days = Math.floor(totalSeconds / (3600 * 24));
        const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        let output = "";
        if (days > 0) output += days + "d ";
        if (hours > 0 || days > 0) output += hours + "h ";
        if (minutes > 0 || hours > 0 || days > 0) output += minutes + "m ";
        output += seconds + "s";
        return output;
      }

      function clearCountdown() {
        if (countdownInterval) clearInterval(countdownInterval);
        countdownInterval = null;
      }

      async function listKeys() {
        clearCountdown();
        const keysList = document.getElementById("keysList");
        const keysListTable = document.getElementById("keysListTable");
        const noKeysText = document.getElementById("noKeysText");
        keysList.innerHTML = "";
        keysListTable.style.display = "none";
        noKeysText.style.display = "none";

        try {
          const res = await fetch("/api/list-keys", { credentials: "include" });
          if (!res.ok) {
            if (res.status === 401) {
              checkStatus();
              return;
            }
            const data = await res.json();
            noKeysText.textContent =
              data.message || "Gagal mengambil daftar key!";
            noKeysText.style.display = "";
            allKeyData = [];
            return;
          }
          const data = await res.json();
          allKeyData = data.activeKeys || [];
          renderKeyList();
          setupCountdown();
        } catch (err) {
          noKeysText.textContent = "Kesalahan server: " + err.message;
          noKeysText.style.display = "";
        }
      }

      function renderKeyList() {
        const searchVal = (
          document.getElementById("searchKeyInput").value || ""
        ).toLowerCase();
        const keysList = document.getElementById("keysList");
        const keysListTable = document.getElementById("keysListTable");
        const noKeysText = document.getElementById("noKeysText");
        keysList.innerHTML = "";
        keysListTable.style.display = "none";
        noKeysText.style.display = "none";

        let filtered = allKeyData;
        if (searchVal) {
          filtered = allKeyData.filter((k) =>
            (k.name || "").toLowerCase().includes(searchVal),
          );
        }
        if (!filtered || filtered.length === 0) {
          noKeysText.textContent =
            "Tidak ada key aktif" + (searchVal ? " sesuai pencarian." : "");
          noKeysText.style.display = "";
          return;
        }
        keysListTable.style.display = "";
        filtered.forEach((k) => {
          const tr = document.createElement("tr");
          let nameCol = "";
          if (currentEditingKey === k.apiKey) {
            nameCol = `<input class="rename-input" id="renameInput" value="${k.name ? k.name.replace(/"/g, "&quot;") : ""}" maxlength="48"/>
                        <button class="rename-btn" onclick="saveRenameKey('${k.apiKey}')">Simpan</button>
                        <button class="rename-btn" style="background:#666;" onclick="cancelRenameKey()">Batal</button>`;
          } else {
            nameCol = `<span>${k.name || "-"}</span>
                        <button class="rename-btn" onclick="editRenameKey('${k.apiKey}')">Rename</button>`;
          }
          let expiredCol = `<span id="expdate-${k.apiKey}">${new Date(k.expiry * 1000).toLocaleString("id-ID", { hour12: false })}</span>
                        <br><span style="color:#43ffae;font-size:.97em;" id="countdown-${k.apiKey}"></span>`;

          // PATCH: Kolom status device
          let deviceStatusCol = "-";
          if (Array.isArray(k.deviceIds) && k.deviceIds.length > 0) {
            deviceStatusCol = k.deviceIds
              .map((dev) => {
                if (!dev || typeof dev !== "object") return "";
                return `<div>
                            <span style="color:#e89cff">${dev.deviceId || "-"}</span>
                            <span class="device-status-${dev.status}">
                              ${dev.status === "online" ? "Online" : "Offline"}
                            </span>
                            <span style="color:#aaa;font-size:.92em">
                              (${dev.lastActive ? new Date(dev.lastActive).toLocaleString("id-ID", { hour12: false }) : ""})
                            </span>
                            ${
                              dev.status === "online"
                                ? `<button class="revoke-btn" style="padding:2px 8px;font-size:.9em" onclick="logoutKeyDevice('${k.apiKey}','${dev.deviceId}')">Logout</button>`
                                : ""
                            }
                          </div>`;
              })
              .join("");
          }

          let revokeCol = `<button class="revoke-btn" onclick="revokeKey('${k.apiKey}')">Revoke</button>
                        <button class="extend-btn" onclick="showExtendModal('${k.apiKey}')">Tambah Waktu</button>`;
          tr.innerHTML = `
                        <td>${k.apiKey}</td>
                        <td>${nameCol}</td>
                        <td>${expiredCol}</td>
                        <td><button class="copy-btn" onclick="navigator.clipboard.writeText('${k.apiKey}')">Copy</button></td>
                        <td>${deviceStatusCol}</td>
                        <td>${revokeCol}</td>
                      `;
          keysList.appendChild(tr);
        });
      }

      function setupCountdown() {
        clearCountdown();
        function updateAllCountdowns() {
          const searchVal = (
            document.getElementById("searchKeyInput").value || ""
          ).toLowerCase();
          let filtered = allKeyData;
          if (searchVal) {
            filtered = allKeyData.filter((k) =>
              (k.name || "").toLowerCase().includes(searchVal),
            );
          }
          const now = Date.now();
          filtered.forEach((k) => {
            const ms = k.expiry * 1000 - now;
            const el = document.getElementById("countdown-" + k.apiKey);
            if (el) el.textContent = formatCountdown(ms);
            if (ms <= 0) {
              listKeys();
            }
          });
        }
        updateAllCountdowns();
        countdownInterval = setInterval(updateAllCountdowns, 1000);
      }

      document.getElementById("listBtn").onclick = listKeys;
      document.getElementById("searchKeyInput").oninput = function () {
        renderKeyList();
        setupCountdown();
      };

      window.editRenameKey = function (apiKey) {
        currentEditingKey = apiKey;
        renderKeyList();
        setupCountdown();
        setTimeout(() => {
          const input = document.getElementById("renameInput");
          if (input) input.focus();
        }, 10);
      };

      window.cancelRenameKey = function () {
        currentEditingKey = null;
        renderKeyList();
        setupCountdown();
      };

      window.saveRenameKey = async function (apiKey) {
        const input = document.getElementById("renameInput");
        if (!input) return;
        const name = input.value.trim();
        try {
          const res = await fetch("/api/rename-key", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ apiKey, name }),
          });
          if (res.ok) {
            currentEditingKey = null;
            await listKeys();
          } else {
            const data = await res.json();
            alert(data.message || "Gagal rename key!");
          }
        } catch (err) {
          alert("Kesalahan server: " + err.message);
        }
      };

      window.revokeKey = async function (apiKey) {
        if (!confirm("Yakin ingin revoke key ini?")) return;
        try {
          const res = await fetch("/api/revoke-key", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ apiKey }),
          });
          if (res.ok) {
            await listKeys();
          } else {
            if (res.status === 401) {
              checkStatus();
              return;
            }
            const data = await res.json();
            alert(data.message || "Gagal revoke key!");
          }
        } catch (err) {
          alert("Kesalahan server: " + err.message);
        }
      };

      function showExtendModal(apiKey) {
        currentExtendKey = apiKey;
        const keyObj = allKeyData.find((k) => k.apiKey === apiKey);
        document.getElementById("extendModal").style.display = "";
        document.getElementById("extendModalKeyName").textContent =
          keyObj?.name || "Tanpa Nama";
        document.getElementById("extendMsg").textContent = "";
        document.getElementById("extendDays").value = "1";
      }

      document.getElementById("cancelExtendBtn").onclick = () => {
        document.getElementById("extendModal").style.display = "none";
        currentExtendKey = null;
      };

      document.getElementById("confirmExtendBtn").onclick = async () => {
        if (!currentExtendKey) return;
        const days = document.getElementById("extendDays").value;
        if (!["1", "2", "3"].includes(days)) {
          document.getElementById("extendMsg").textContent =
            "Silakan pilih hari!";
          return;
        }
        document.getElementById("extendMsg").textContent = "";
        try {
          const res = await fetch("/api/extend-key", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
              apiKey: currentExtendKey,
              days: Number(days),
            }),
          });
          if (res.ok) {
            document.getElementById("extendModal").style.display = "none";
            currentExtendKey = null;
            await listKeys();
          } else {
            const data = await res.json();
            document.getElementById("extendMsg").textContent =
              data.message || "Gagal menambah waktu!";
          }
        } catch (err) {
          document.getElementById("extendMsg").textContent =
            "Kesalahan server: " + err.message;
        }
      };

      // PATCH: Fungsi untuk logout device (set status offline)
      window.logoutKeyDevice = async function (apiKey, deviceId) {
        if (!confirm("Yakin ingin logout device ini?")) return;
        try {
          const res = await fetch("/api/logout-key", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ apiKey, deviceId }),
          });
          const data = await res.json();
          if (res.ok) {
            await listKeys();
          } else {
            alert(data.message || "Gagal logout device!");
          }
        } catch (err) {
          alert("Kesalahan server: " + err.message);
        }
      };

      document.getElementById("generateBtn").onclick = async () => {
        const expireDays = document.getElementById("expireDays").value;
        const keyName = document.getElementById("keyName").value.trim();
        const maxDevices = document.getElementById("maxDevices").value;
        try {
          const res = await fetch("/api/generate-key", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ expireDays, name: keyName, maxDevices }),
          });
          if (!res.ok) {
            if (res.status === 401) {
              checkStatus();
              return;
            }
            const data = await res.json();
            document.getElementById("genResult").innerHTML =
              `<span class="error">${data.message}</span>`;
            return;
          }
          const data = await res.json();
          document.getElementById("genResult").innerHTML =
            `<span class="success">Key berhasil dibuat:<br><b style="word-break:break-all">${data.apiKey}</b><br>
                        ${data.name ? `<span style="color:#e89cff;">"${data.name}"</span><br>` : ""}
                        Expired: ${new Date(data.expiry * 1000).toLocaleString("id-ID", { hour12: false })}</span>`;
          await listKeys();
        } catch (err) {
          document.getElementById("genResult").innerHTML =
            `<span class="error">Kesalahan server: ${err.message}</span>`;
        }
      };

      document.getElementById("registerBtn").onclick = register;
      document.getElementById("changePasswordBtn").onclick = changePassword;
      window.showPage = showPage;
      window.approveUser = approveUser;
      window.rejectUser = rejectUser;
      window.deleteAdmin = deleteAdmin;

      checkStatus();

      // --- Tambahan script panel chat cookies ---
      const origShowPage = window.showPage;
      window.showPage = function (page) {
        origShowPage(page);
        document.getElementById("pageCookies").style.display =
          page === "cookies" ? "" : "none";
        document
          .getElementById("navCookies")
          .classList.toggle("active", page === "cookies");
        if (page === "cookies") loadCookiesPanel();
      };

      // Fungsi untuk load panel cookies
      let cookiePanelInterval = null;
      function loadCookiesPanel() {
        refreshCookieChat();
        if (cookiePanelInterval) clearInterval(cookiePanelInterval);
        cookiePanelInterval = setInterval(refreshCookieChat, 3000);
      }
      function refreshCookieChat() {
        fetch("/cookies", { credentials: "include" })
          .then((res) => res.json())
          .then((data) => {
            const list = data.list || [];
            const chatDiv = document.getElementById("cookieChatList");
            chatDiv.innerHTML = "";
            if (!list.length) {
              chatDiv.innerHTML =
                "<div class='cookie-chat-empty'>Belum ada cookie diterima dari extension.</div>";
              return;
            }
            list.forEach((item) => {
              const el = document.createElement("div");
              el.className = "cookie-chat-item";
              el.innerHTML = `
                            <div class="cookie-chat-cookie">${item.value}</div>
                            <div class="cookie-chat-meta">
                              <span style="color:#e89cff;">${item.keyName ? "Key: <span class='cookie-chat-keyname'>" + item.keyName + "</span>" : "<i>Key tidak terdeteksi</i>"}</span>
                              ${item.deviceId ? `<span class="cookie-chat-device" title="Device ID">${item.deviceId}</span>` : ""}
                              <span>${new Date(item.time).toLocaleString("id-ID", { hour12: false })}</span>
                              <span class="cookie-chat-ip">IP: ${item.ip ?? ""}</span>
                              <span class="cookie-chat-ua" title="${item.ua || ""}">${item.ua?.slice(0, 36) || ""}${item.ua && item.ua.length > 36 ? "..." : ""}</span>
                            </div>`;
              chatDiv.appendChild(el);
            });
          });
      }
      // Tombol refresh manual
      document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("refreshCookieBtn");
        if (btn) btn.onclick = refreshCookieChat;
      });
    </script>
  </body>
</html>
